name: Build With CMake + Ninja

env:
  PLUGIN_NAME: CustomBallOnline

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      artifact_suffix:
        required: true
        type: string
permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: ğŸ“¥ Checkout repository (${{ inputs.branch }})
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          submodules: false

      - name: ğŸ† Initialize submodules
        run: ./scripts/init-submodules.bat

      - name: ğŸªŸ Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: âš™ï¸ Set up CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: ğŸ¥· Set up Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: ğŸ§± Configure project (CMake)
        run: cmake --preset windows-x64-msvc

      - name: ğŸ”¨ Build project (CMake)
        run: cmake --build build

      - name: ğŸ¥µ Prepare artifact files (${{ inputs.artifact_suffix }})
        shell: bash
        run: |
          mkdir -p dist temp/debug temp/installation_zip
          cp ./plugins/*.dll temp/installation_zip
          cp ./scripts/install.bat temp/installation_zip
          7z a "dist/${{ env.PLUGIN_NAME }}${{ inputs.artifact_suffix }}.zip" ./temp/installation_zip/*

      - name: ğŸ”‘ Attest release ZIP
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/${{ env.PLUGIN_NAME }}${{ inputs.artifact_suffix }}.zip"

      - name: ğŸ“¦ Upload build artifacts (${{ inputs.artifact_suffix }})
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: artifacts${{ inputs.artifact_suffix }}
          path: dist/*
